---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: legacy-mastodon
  namespace: social
spec:
  interval: 15m
  chart:
    spec:
      chart: mastodon
      version: 6.8.1
      sourceRef:
        kind: HelmRepository
        name: wrmilling-charts
        namespace: flux-system
  values:
    image:
      repository: ghcr.io/glitch-soc/mastodon
      tag: nightly.2026-02-11
      pullPolicy: IfNotPresent

    mastodon:
      createAdmin:
        enabled: false
        username: "winston"
        email: "winston@${SECRET_DOMAIN_SECONDARY}"
      local_domain: "${SECRET_DOMAIN_SECONDARY}"
      web_domain: "mastodon.${SECRET_DOMAIN}"
      singleUserMode: true
      extraEnvVars:
        MAX_TOOT_CHARS: 2048
      hooks:
        dbPrepare:
          enabled: false
        dbMigrate:
          enabled: false
      deploySearch:
        enabled: false
      s3:
        enabled: true
        access_key: "${SECRET_MASTODON_S3_ACCESS_KEY}"
        access_secret: "${SECRET_MASTODON_S3_SECRET_KEY}"
        bucket: "mastodon"
        endpoint: "https://mfile.${SECRET_DOMAIN}"
        hostname: "mfile.${SECRET_DOMAIN}"
        alias_host: "mcdn.${SECRET_DOMAIN}"
      secrets:
        secret_key_base: "${SECRET_MASTODON_SECRET_KEY_BASE}"
        otp_secret: "${SECRET_MASTODON_OTP_SECRET}"
        vapid:
          private_key: "${SECRET_MASTODON_VAPID_PRIVATE_KEY}"
          public_key: "${SECRET_MASTODON_VAPID_PUBLIC_KEY}"
        activeRecordEncryption:
          primaryKey: "${SECRET_MASTODON_AR_PRIMARY_KEY}"
          deterministicKey: "${SECRET_MASTODON_AR_DETERMINISTIC_KEY}"
          keyDerivationSalt: "${SECRET_MASTODON_AR_KEY_DERIVATION_SALT}"
      sidekiq:
        workers:
          - name: all-queues
            concurrency: 25
            replicas: 1
            resources: {}
            affinity: {}
            queues:
              - default,8
              - push,6
              - ingress,4
              - mailers,2
              - pull
              - scheduler # Make sure the scheduler queue only exists once and with a worker that has 1 replica.
          - name: pull-ingress
            concurrency: 50
            replicas: 1
            resources: {}
            affinity: {}
            queues:
              - pull
              - ingress
      smtp:
        domain: "${SECRET_DOMAIN}"
        from_address: "${SECRET_MASTODON_SMTP_FROM_ADDRESS}"
        server: "${SECRET_SMTP_DOMAIN}"
        port: 587
        login: "${SECRET_SMTP_USERNAME}"
        password: "${SECRET_SMTP_PASSWORD}"
      streaming:
        image:
          repository: ghcr.io/glitch-soc/mastodon-streaming
          tag: nightly.2026-02-11
        port: 4000
      web:
        port: 3000

    ingress:
      enabled: false

    httproute:
      enabled: true
      parentRefs:
        - group: gateway.networking.k8s.io
          kind: Gateway
          name: external-gateway
          namespace: kube-system
          sectionName: https
      hostnames:
        - mastodon.${SECRET_DOMAIN}
      rules:
        - matches:
            - path:
                type: PathPrefix
                value: /
      streamingHostnames:
        - mastodon.${SECRET_DOMAIN}
      streamingRules:
        - matches:
            - path:
                type: PathPrefix
                value: /api/v1/streaming

    elasticsearch:
      enabled: false

    postgresql:
      enabled: false
      postgresqlHostname: mastodon-psql-v17-rw.default.svc
      postgresqlPort: 5432
      auth:
        database: mastodon
        username: mastodon
        password: "${SECRET_MASTODON_DB_PASS}"
        postgresPassword: "${SECRET_MASTODON_POSTGRES_POSTGRES_PASSWORD}"
        # existingSecret: mastodon-postgresql

    redis:
      enabled: false
      hostname: mastodon-valkey-primary.social.svc
      auth:
        password: "${SECRET_MASTODON_REDIS_PASSWORD}"
