image: alpine/edge
secrets:
- 26e0dc51-9620-4f61-82e2-998932a415c7
sources:
- https://git.sr.ht/~wrmilling/k3s-gitops
tasks:
- prep-remotes: |
    # Set Repo Name, move to repo
    REPO=k3s-gitops
    cd $REPO

    # Ignore hosts keys, since we accept them as-is, add remotes
    git config --global core.sshCommand 'ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no'
    git remote add github git@github.com:wrmilling/${REPO}.git
    git remote add codeberg git@codeberg.org:wrmilling/${REPO}.git
    git remote add gitlab git@gitlab.com:WRMilling/${REPO}.git
- push-master: |
    # Set Repo Name
    REPO=k3s-gitops
    BRANCH=master
    cd $REPO

    # Ensure we are on the configured branch, exit build if not
    git diff -s --exit-code origin/${BRANCH} || complete-build
    git checkout $BRANCH

    # Push copy of code to remotes
    git push github $BRANCH
    git push codeberg $BRANCH
    git push gitlab $BRANCH
- push-main: |
   # Set Repo Name
    REPO=k3s-gitops
    BRANCH=main
    cd $REPO

    # Ensure we are on the configured branch, exit build if not
    git diff -s --exit-code origin/${BRANCH} || complete-build
    git checkout $BRANCH

    # Push copy of code to remotes
    git push github $BRANCH
    git push codeberg $BRANCH
    git push gitlab $BRANCH
