image: alpine/edge
secrets:
- 26e0dc51-9620-4f61-82e2-998932a415c7
sources:
- https://git.sr.ht/~wrmilling/k3s-gitops
environment:
  REPO: k3s-gitops
tasks:
- prep-remotes: |
    cd $REPO

    # Ignore hosts keys, since we accept them as-is, add remotes
    git config --global core.sshCommand 'ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no'
    git remote add github git@github.com:wrmilling/${REPO}.git
    git remote add codeberg git@codeberg.org:wrmilling/${REPO}.git
    git remote add gitlab git@gitlab.com:wrmilling/${REPO}.git
    git remote add homelab git@git.homelab.tokyo:wrmilling/${REPO}.git
- push-master: |
    BRANCH=master

    cd $REPO
    if git diff -s --exit-code origin/${BRANCH}; then
        git checkout ${BRANCH}
        git push github $BRANCH
        git push codeberg $BRANCH
        git push gitlab $BRANCH
        git push homelab $BRANCH
    fi
- push-main: |
    BRANCH=main

    cd $REPO
    if git diff -s --exit-code origin/${BRANCH}; then
        git checkout ${BRANCH}
        git push github $BRANCH
        git push codeberg $BRANCH
        git push gitlab $BRANCH
        git push homelab $BRANCH
    fi
