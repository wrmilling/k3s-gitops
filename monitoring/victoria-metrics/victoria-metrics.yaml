# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: victoria-metrics
  namespace: monitoring
spec:
  chart:
    spec:
      chart: victoria-metrics-k8s-stack
      version: 0.70.0
      sourceRef:
        kind: HelmRepository
        name: victoriametrics-charts
        namespace: flux-system
      interval: 2h
  interval: 1h
  install:
    createNamespace: true
  values:
    fullnameOverride: stack

    defaultDashboards:
      enabled: true

    vmsingle:
      enabled: true
      spec:
        retentionPeriod: "3"
        replicaCount: 1
        storage:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 60Gi
        resources:
          limits:
            memory: 2Gi
          requests:
            cpu: 530m
            memory: 1.2Gi
      ingress:
        enabled: false
      route:
        enabled: true
        labels:
          error-pages: enabled
        parentRefs:
          - name: internal
            namespace: kube-system
            sectionName: https
        hostnames:
          - vm.k.${SECRET_DOMAIN}

    alertmanager:
      enabled: true
      spec:
        externalURL: "https://vm-alert.${SECRET_DOMAIN}"
        routePrefix: /
      ingress:
        enabled: false
      route:
        enabled: true
        labels:
          error-pages: enabled
        parentRefs:
          - name: internal
            namespace: kube-system
            sectionName: https
        hostnames:
          - vm-alert.k.${SECRET_DOMAIN}
      config:
        route:
          receiver: "blackhole"
          group_by: ["alertname", "severity"]
          group_wait: 30s
          group_interval: 10m
          repeat_interval: 12h
          routes:
            - matchers:
                - alertname=~"WatchDog|InfoInhibitor|KubeMemoryOvercommit|CephNodeNetworkPacketErrors"
              receiver: "blackhole"
            - matchers:
                - severity = "critical"
                - alertname=~"Host.*|Node.*|Zfs.*|UPS.*|Smartctl.*"
              receiver: "critical-discord"
              group_by: ["alertname", "instance"]
              group_wait: 10s
              continue: false
            - matchers:
                - severity = "warning"
                - alertname=~"Host.*|Node.*|Zfs.*|UPS.*|Smartctl.*"
              receiver: "warning-discord"
              group_by: ["alertname", "instance"]
              continue: false
            - matchers:
                - severity = "critical"
                - alertname=~".*Pod.*|.*Container.*|.*Deployment.*|Cert.*|Flux.*|VolSync.*|Envoy.*|PG.*"
              receiver: "critical-discord"
              group_by: ["alertname", "namespace"]
              group_wait: 10s
              continue: false
            - matchers:
                - severity = "warning"
                - alertname=~".*Pod.*|.*Container.*|.*Deployment.*|Cert.*|Flux.*|VolSync.*|Envoy.*|PG.*"
              receiver: "warning-discord"
              group_by: ["alertname", "namespace"]
              continue: false
            - matchers:
                - severity = "critical"
              receiver: "critical-discord"
              group_by: ["alertname"]
              group_wait: 10s
              continue: false
            - matchers:
                - severity = "warning"
              receiver: "warning-discord"
              group_by: ["alertname"]
              continue: false
        inhibit_rules:
          - source_matchers:
              - severity = "critical"
            target_matchers:
              - severity =~ "warning|info"
            equal: ["namespace", "alertname"]
          - source_matchers:
              - severity = "warning"
            target_matchers:
              - severity = "info"
            equal: ["namespace", "alertname"]
          - source_matchers:
              - alertname = "InfoInhibitor"
            target_matchers:
              - severity = "info"
            equal: ["namespace"]
          - target_matchers:
              - alertname = "InfoInhibitor"
        receivers:
          - name: "blackhole"
          - name: "critical-discord"
            discord_configs:
              - webhook_url: "${SECRET_KPS_SLACK_API_URL}"
                send_resolved: true
                title: '[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ if eq .Status "firing" }}üî•{{ else }}‚úÖ{{ end }} {{ if ne .CommonAnnotations.summary ""}}{{ .CommonAnnotations.summary }}{{ else if ne .CommonAnnotations.message ""}}{{ .CommonAnnotations.message }}{{ else if ne .CommonAnnotations.description ""}}{{ .CommonAnnotations.description }}{{ else }}{{ .CommonLabels.alertname }}{{ end }}'
                message: |-
                  {{ range .Alerts -}}
                  **Alert:** {{ .Annotations.title }}{{ if .Labels.severity }} - `{{ .Labels.severity }}`{{ end }}

                  {{ if ne .Annotations.summary ""}}**Summary:** {{ .Annotations.summary }}{{ else if ne .Annotations.message ""}}**Message:** {{ .Annotations.message }}{{ else if ne .Annotations.description ""}}**Description:** {{ .Annotations.description }}{{ end }}

                  üè∑ **Labels:**
                  {{ range .Labels.SortedPairs }} ‚Ä¢ {{ .Name }}: {{ .Value }}
                  {{ end }}
                  {{ end }}
          - name: "warning-discord"
            discord_configs:
              - webhook_url: "${SECRET_KPS_SLACK_API_URL}"
                send_resolved: true
                title: '[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ if eq .Status "firing" }}‚ö†Ô∏è{{ else }}‚úÖ{{ end }} {{ if ne .CommonAnnotations.summary ""}}{{ .CommonAnnotations.summary }}{{ else if ne .CommonAnnotations.message ""}}{{ .CommonAnnotations.message }}{{ else if ne .CommonAnnotations.description ""}}{{ .CommonAnnotations.description }}{{ else }}{{ .CommonLabels.alertname }}{{ end }}'
                message: |-
                  {{ range .Alerts -}}
                  **Alert:** {{ .Annotations.title }}{{ if .Labels.severity }} - `{{ .Labels.severity }}`{{ end }}

                  {{ if ne .Annotations.summary ""}}**Summary:** {{ .Annotations.summary }}{{ else if ne .Annotations.message ""}}**Message:** {{ .Annotations.message }}{{ else if ne .Annotations.description ""}}**Description:** {{ .Annotations.description }}{{ end }}

                  üè∑ **Labels:**
                  {{ range .Labels.SortedPairs }} ‚Ä¢ {{ .Name }}: {{ .Value }}
                  {{ end }}
                  {{ end }}

    vmalert:
      enabled: true
      spec:
        extraArgs:
          external.url: "https://vmalert.${SECRET_DOMAIN}"
        evaluationInterval: 15s
      ingress:
        enabled: false
      route:
        enabled: true
        labels:
          error-pages: enabled
        parentRefs:
          - name: internal
            namespace: kube-system
            sectionName: https
        hostnames:
          - vmalert.k.${SECRET_DOMAIN}

    vmagent:
      enabled: true
      spec:
        scrapeInterval: 20s
        externalLabels:
          cluster: k3s
      ingress:
        enabled: false
      route:
        enabled: true
        labels:
          error-pages: enabled
        parentRefs:
          - name: internal
            namespace: kube-system
            sectionName: https
        hostnames:
          - vmagent.k.${SECRET_DOMAIN}

    grafana:
      enabled: false
